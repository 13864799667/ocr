# 批量文件夹OCR处理脚本使用说明

## 概述

`batch_folder_process.py` 是一个自动化批量处理脚本，用于处理按年龄段分类的多个文件夹中的图片。该脚本基于 `one_key_process.py` 的核心逻辑开发，完全复用其OCR识别参数和处理策略。

## 功能特点

- **自动扫描**：自动识别所有年龄段文件夹
- **并行处理**：OCR识别阶段使用多进程并行，充分利用CPU
- **独立处理**：每个年龄段完全独立处理，数据不会混淆
- **自动打包**：处理完成后自动将ROI图片和分割输出打包为zip
- **自动清理**：处理完一个年龄段后自动清理临时文件
- **详细日志**：记录完整的处理过程和统计信息

## 文件夹结构要求

```
大文件夹/                          # 输入参数指定的目录
├── 20-女-166/                     # 年龄段文件夹
│   ├── 正常报告/
│   │   └── 图/                    # ← 图片在这里
│   │       ├── xxx.jpg
│   │       └── ...
│   └── 异常报告/
├── 30-女-166/
│   ├── 正常报告/
│   │   └── 图/
│   └── 异常报告/
├── 40-女-166/
│   └── ...
├── 50-女-166/
│   └── ...
└── 60-女-166/
    └── ...
```

## 输出结果

处理完成后，每个年龄段的 `正常报告/` 目录下会生成：

```
正常报告/
├── 图/                            # 原始图片（不变）
├── 20-女-166_results.xlsx         # OCR识别结果Excel
├── 20-女-166_roi_images.zip       # ROI截图打包
└── 20-女-166_all_output.zip       # 分割图片打包
```

## 使用方法

### 基本用法

```bash
python batch_folder_process.py <大文件夹路径>
```

### 示例

```bash
# 处理女-166文件夹下的所有年龄段
python batch_folder_process.py /home/lys/ocr_demo/女-166

# 启用调试模式（输出更详细的日志）
python batch_folder_process.py /home/lys/ocr_demo/女-166 --debug

# 调整并行进程数（默认12，根据CPU核心数调整）
python batch_folder_process.py /home/lys/ocr_demo/女-166 --workers 8

# 调整ROI扩展像素（默认10像素）
python batch_folder_process.py /home/lys/ocr_demo/女-166 --roi_expand 15

# 组合使用
python batch_folder_process.py /home/lys/ocr_demo/女-166 --workers 8 --roi_expand 15 --debug
```

### 命令行参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `base_dir` | 包含多个年龄段文件夹的大文件夹路径 | 必填 |
| `--workers` | OCR并行进程数 | 12 |
| `--roi_expand` | ROI扩展像素数 | 10 |
| `--debug` | 启用调试模式 | 关闭 |

## 性能调优

### 并行进程数 (--workers)

- **默认值**：12
- **建议**：设置为CPU核心数或略少
- **查看CPU核心数**：`nproc` 或 `lscpu`

```bash
# 8核CPU建议
python batch_folder_process.py /path/to/folder --workers 8

# 16核CPU建议
python batch_folder_process.py /path/to/folder --workers 16
```

### 内存考虑

- 每个并行进程会加载一个PaddleOCR实例
- 建议：每个进程预留约1GB内存
- 如果内存不足，减少 `--workers` 数量

## 处理流程

对于每个年龄段文件夹，脚本执行以下步骤：

1. **清空临时目录**：确保不会混入上一个年龄段的数据
2. **图片分割**（串行）：调用 `split_image.py` 将长图分割成小图
3. **OCR识别**（并行）：使用多进程并行处理分割后的图片目录
4. **保存Excel**：将识别结果保存为Excel文件
5. **打包ROI**：将ROI截图打包为zip文件
6. **打包分割输出**：将分割后的图片打包为zip文件
7. **清理临时目录**：删除临时文件，准备处理下一个年龄段

### 并行处理示意图

```
年龄段处理流程:
┌─────────────────────────────────────────────────────────┐
│ 步骤1-2: 清空目录 + 图片分割 (串行)                      │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│ 步骤3: OCR识别 (并行)                                    │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐     ┌─────────┐   │
│  │ 进程1   │ │ 进程2   │ │ 进程3   │ ... │ 进程N   │   │
│  │ 目录A   │ │ 目录B   │ │ 目录C   │     │ 目录X   │   │
│  └─────────┘ └─────────┘ └─────────┘     └─────────┘   │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│ 步骤4-7: 保存Excel + 打包 + 清理 (串行)                  │
└─────────────────────────────────────────────────────────┘
```

## 依赖要求

确保已安装以下依赖：

```bash
pip install paddlepaddle paddleocr opencv-python pandas openpyxl pillow numpy
```

或使用项目的 `requirements.txt`：

```bash
pip install -r requirements.txt
```

## 必要文件

脚本运行需要以下文件在同一目录下：

- `batch_folder_process.py` - 批量处理脚本
- `split_image.py` - 图片分割脚本

## 日志文件

处理过程会生成日志文件 `batch_process.log`，包含：

- 处理进度
- 每个年龄段的处理详情
- 错误信息
- 时间统计

## 常见问题

### Q1: 提示找不到 split_image.py

确保 `split_image.py` 文件与 `batch_folder_process.py` 在同一目录下。

### Q2: 某个年龄段处理失败

查看 `batch_process.log` 日志文件，找到具体的错误信息。常见原因：
- 图片目录为空
- 图片格式不支持
- 内存不足

### Q3: 处理速度慢

- 确保有足够的内存（建议8GB以上）
- 可以尝试减少 `--roi_expand` 参数值
- 检查是否有其他程序占用CPU

### Q4: 识别结果不准确

- 检查图片质量和清晰度
- 尝试调整 `--roi_expand` 参数
- 查看ROI截图确认坐标是否正确

## 与 one_key_process.py 的关系

`batch_folder_process.py` 完全基于 `one_key_process.py` 的核心逻辑：

- **相同的坐标配置**：使用相同的 `COORDINATE_DATA_ENHANCED`
- **相同的预处理策略**：使用相同的图像预处理函数
- **相同的OCR参数**：使用相同的PaddleOCR配置
- **相同的数字提取逻辑**：使用相同的数字提取和处理函数

主要区别：
- 支持批量处理多个文件夹
- 自动打包输出文件
- 自动清理临时文件
- 更详细的进度显示

## 版本信息

- 版本：v1.1 (并行版)
- 基于：one_key_process.py v2.0
- 作者：Kiro

## 更新日志

### v1.1 (2026-01-09)
- 添加OCR识别并行处理功能
- 新增 `--workers` 参数控制并行进程数
- 性能大幅提升，充分利用多核CPU

### v1.0 (2026-01-09)
- 初始版本
- 支持批量处理多个年龄段文件夹
- 自动打包和清理功能
- 详细的日志记录
